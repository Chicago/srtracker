<!DOCTYPE html>
<html class="detail_page">
	<head>
		<meta charset="utf-8" />
		<title>{{ sr.service_name }} #{{ sr.service_request_id }} - 311 Service Tracker</title>
		<link rel="stylesheet" href="/static/arvo-fontfacekit/stylesheet.css" type="text/css" />
		<link rel="stylesheet" href="/static/css/base.css" type="text/css" />
		<link rel="stylesheet" href="/static/css/service_request.css" type="text/css" />
		
		<script src="/static/js/jquery-1.8.0.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="/static/js/validation.js" type="text/javascript" charset="utf-8"></script>
	</head>
	<body>
		
		<header>
			<a href="/" class="site_title">311 Service Tracker</a>
			<form method="GET" action="/requests">
				<label id="request_id_label" for="status_lookup">Check the status of:</label>
				<input name="request_id" id="status_lookup" class="search_field" type="text" placeholder="Enter Service Request #" />
				<input type="submit" class="submit" value="Submit" />
			</form>
		</header>
		
		<article class="main_content">
		
			<h1>{{ sr.service_name }}</h1>
			
			<div class="request_details {% if sr.media_url %}has_media{% endif %}">
				{# if sr.media_url #}
					<img src="{{ sr.media_url }}" class="request_media" alt="" />
				{# endif #}
				
				<p class="status_indicator status-{{ sr.status }}">{{ sr.status.title() }}</p>
				
				<div class="request_id">#{{ sr.service_request_id }}</div>
				
				<p><strong>Description:</strong> {{ sr.description }}</p>
				<p><strong>Address:</strong> {{ sr.address.title().split(",", 1)[0] }}, {{ sr.address.title().split(",", 1)[1].replace("Il", "IL") }}</p>
				<p><strong>Created:</strong> {{ sr.requested_datetime.strftime('%B %d, %Y') }}</p>
				{%  if sr.extended_attributes and sr.extended_attributes.channel %}
					<p><strong>Received via:</strong> {{ sr.extended_attributes.channel.title() }}</p>
				{% endif %}
				
				<div class="clearfix"></div>
			</div>
			
			
			<aside class="request_extras">
				{% if sr.status == 'open' %}
					{% if subscribed %}
					<div class="extras_content">
						<h2>You’ve Subscribed</h2>
						<p>
							Thanks for subscribing to updates for this request.
							We’ll e-mail you when work is done on this service request.
						</p>
					</div>
					{% else %}
					<div class="extras_content">
						<h2>Stay Up To Date</h2>
						<p>Get notified of any changes to this service request by email.</p>
						<form method="POST" action="/subscribe/{{ sr.service_request_id }}" id="subscription_form">
							<label for="update_email" class="use_placeholder">E-Mail:</label>
							<input type="email" id="update_email" name="update_email" placeholder="Enter your e-mail address" />
							<p class="error_message">Please use a valid e-mail address.</p>
							<input type="submit" class="submit" value="Notify Me!" />
						</form>
					</div>
					{% endif %}
				{% endif %}
			</aside>
			
			<h2 class="activity_header">Activity</h2>
			<ol class="notes_list">
				{% for note in sr.notes %}
					{% if (note.type != 'follow_on' or 'Closed' not in note.description) and note.type != 'opened' %}
						<li class="note note-{{ note.type }}">
						
							<div class="note_indicator"></div>
							
							{% if note.datetime %}
								<span class="datetime">
									<span class="date">{{ note.datetime.strftime('%d-%b-%Y') }}</span>
									<span class="time">{{ note.datetime.strftime('%I:%M %p').strip('0') }}</span>
								</span>
							{% endif %}
							
							<div class="details">
								<p>
									{% if note.type == 'follow_on' %}
										<strong>{{ note.extended_attributes.service_name }}</strong><br/>
										Department: {{ note.extended_attributes.agency_responsible }}
										{% if note.extended_attributes.closed_datetime %}
											<div>
												Completed on {{ note.extended_attributes.closed_datetime.strftime('%d-%b-%Y') }}
												at {{ note.extended_attributes.closed_datetime.strftime('%I:%M %p').strip('0') }}
											</div>
										{% else %}
											<div class="ongoing">
												In progress
											</div>
										{% endif %}
									{% else %}
										{% if note.summary %}<div class="note_summary">{{ note.summary }}</div>{% endif %}
										{% if note.description %}<div class="note_description">{{ note.description }}</div>{% endif %}
									{% endif %}
								</p>
							</div>
						</li>
					{% endif %}
				{% endfor %}
				
				{# And of course the SR itself... #}
				<li class="note note-initial note-follow_on">
					<div class="note_indicator"></div>
					<span class="datetime">
						<span class="date">{{ sr.requested_datetime.strftime('%d-%b-%Y') }}</span>
						<span class="time">{{ sr.requested_datetime.strftime('%I:%M %p').strip('0') }}</span>
					</span>
					<div class="details">
						<p>
							<strong>{{ sr.service_name }}</strong><br/>
							Department: {{ sr.agency_responsible }}
							{%  if sr.extended_attributes and sr.extended_attributes.channel %}
								<br/>via {{ sr.extended_attributes.channel.title() }}
							{% endif %}
						</p>
					</div>
				</li>
			</ol>
		
		</article>
		
	</body>
</html>